<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Club de los Inventores</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4A90D9;
            --primary-dark: #2E6BB0;
            --secondary: #6B8E23;
            --accent: #F5A623;
            --background: #FFF9F0;
            --text: #2D3436;
            --text-light: #636E72;
            --card-bg: #FFFFFF;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.8;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .header h1 {
            font-family: 'Merriweather', serif;
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .header .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Container */
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 2rem 0;
        }

        .welcome-screen h2 {
            font-family: 'Merriweather', serif;
            color: var(--primary-dark);
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .welcome-screen p {
            color: var(--text-light);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-group label .emoji {
            margin-right: 0.5rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            background: var(--card-bg);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.2);
        }

        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: inherit;
            background: linear-gradient(135deg, var(--accent) 0%, #E09612 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(245, 166, 35, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 166, 35, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 15px rgba(74, 144, 217, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(74, 144, 217, 0.5);
        }

        /* Story Screen */
        .story-screen {
            display: none;
        }

        .chapter-illustration {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .chapter-title {
            font-family: 'Merriweather', serif;
            color: var(--primary-dark);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--accent);
        }

        .chapter-content {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .chapter-content p {
            margin-bottom: 1rem;
        }

        .chapter-content em {
            color: var(--primary-dark);
        }

        .chapter-content blockquote {
            background: linear-gradient(135deg, #F0F8FF 0%, #E8F4FD 100%);
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 12px 12px 0;
            font-style: italic;
        }

        /* Info boxes */
        .info-box {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .info-box.sabias-que {
            border-left: 4px solid var(--secondary);
        }

        .info-box.actividad {
            border-left: 4px solid var(--accent);
        }

        .info-box h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-box.sabias-que h3 { color: var(--secondary); }
        .info-box.actividad h3 { color: #D4850F; }

        /* Decisions */
        .decision-box {
            background: linear-gradient(135deg, #FFF5E6 0%, #FFECD2 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .decision-box h3 {
            color: var(--accent);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .decision-btn {
            display: block;
            width: 100%;
            padding: 1rem 1.5rem;
            margin: 0.75rem 0;
            font-family: inherit;
            font-size: 1rem;
            text-align: left;
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .decision-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateX(5px);
        }

        .decision-btn .option {
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .decision-btn:hover .option {
            color: white;
        }

        .decision-btn .description {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .decision-btn:hover .description {
            color: rgba(255,255,255,0.9);
        }

        /* Quote */
        .chapter-quote {
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
            font-style: italic;
            color: var(--text-light);
            border-top: 1px solid #E0E0E0;
        }

        /* Progress */
        .progress-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            padding: 0.75rem 1rem;
            box-shadow: 0 -2px 10px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .progress-info {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .progress-track {
            flex: 1;
            height: 6px;
            background: #E0E0E0;
            border-radius: 3px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .menu-btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-family: inherit;
            background: transparent;
            border: 1px solid var(--text-light);
            border-radius: 20px;
            cursor: pointer;
            color: var(--text-light);
        }

        .menu-btn:hover {
            background: var(--text-light);
            color: white;
        }

        /* Achievements (Final) */
        .achievements {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .achievement {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .achievement .badge {
            font-size: 2rem;
        }

        .achievement .text {
            font-weight: 600;
        }

        /* Ending */
        .ending {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 16px;
            margin: 2rem 0;
        }

        .ending h2 {
            color: var(--secondary);
            font-family: 'Merriweather', serif;
            margin-bottom: 1rem;
        }

        .stars {
            font-size: 2rem;
            margin: 1rem 0;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            .chapter-title {
                font-size: 1.5rem;
            }

            .chapter-content {
                font-size: 1rem;
            }

            .welcome-screen h2 {
                font-size: 1.5rem;
            }
        }

        /* Menu modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-dark);
        }

        .modal-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            font-family: inherit;
            font-size: 1rem;
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            color: var(--primary);
        }

        .modal-btn:hover {
            background: var(--primary);
            color: white;
        }

        .modal-btn.danger {
            border-color: #E74C3C;
            color: #E74C3C;
        }

        .modal-btn.danger:hover {
            background: #E74C3C;
            color: white;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üìö El Club de los Inventores</h1>
        <div class="subtitle">Una historia interactiva para peque√±os curiosos</div>
    </header>

    <main class="container">
        <!-- WELCOME SCREEN -->
        <section id="welcome-screen" class="welcome-screen">
            <h2>¬°Bienvenido/a, futuro/a inventor/a!</h2>
            <p>Antes de comenzar tu aventura, contanos un poco sobre vos:</p>

            <form id="personalization-form">
                <div class="form-group">
                    <label><span class="emoji">üë§</span>¬øCu√°l es tu nombre?</label>
                    <input type="text" id="input-nombre" required placeholder="Tu nombre">
                </div>

                <div class="form-group">
                    <label><span class="emoji">üë´</span>¬øC√≥mo se llama tu mejor amigo/a?</label>
                    <input type="text" id="input-amigo" required placeholder="Nombre de tu amigo/a">
                </div>

                <div class="form-group">
                    <label><span class="emoji">üèôÔ∏è</span>¬øEn qu√© ciudad viv√≠s?</label>
                    <input type="text" id="input-ciudad" required placeholder="Tu ciudad">
                </div>

                <div class="form-group">
                    <label><span class="emoji">üî¨</span>¬øQui√©n es tu inventor/a favorito/a?</label>
                    <select id="input-inventor" required>
                        <option value="">Eleg√≠ uno...</option>
                        <option value="Thomas Edison">Thomas Edison (Bombilla el√©ctrica)</option>
                        <option value="Marie Curie">Marie Curie (Radioactividad)</option>
                        <option value="Leonardo da Vinci">Leonardo da Vinci (Mil inventos)</option>
                        <option value="Nikola Tesla">Nikola Tesla (Electricidad)</option>
                    </select>
                </div>

                <button type="submit" class="btn">üöÄ ¬°Comenzar la aventura!</button>
            </form>
        </section>

        <!-- STORY SCREEN -->
        <section id="story-screen" class="story-screen">
            <img id="chapter-image" class="chapter-illustration" src="" alt="">
            <h2 id="chapter-title" class="chapter-title"></h2>
            <div id="chapter-content" class="chapter-content"></div>
            <div id="chapter-extras"></div>
            <div id="chapter-decisions" class="decision-box hidden">
                <h3>‚ö° ¬øQu√© hacemos?</h3>
                <div id="decisions-container"></div>
            </div>
            <div id="chapter-quote" class="chapter-quote"></div>
        </section>
    </main>

    <!-- PROGRESS BAR -->
    <div id="progress-bar" class="progress-bar hidden">
        <span class="progress-info" id="progress-text">Cap√≠tulo 1</span>
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill" style="width: 10%"></div>
        </div>
        <button class="menu-btn" id="menu-btn">‚ò∞ Men√∫</button>
    </div>

    <!-- MENU MODAL -->
    <div id="menu-modal" class="modal-overlay">
        <div class="modal">
            <h3>üìñ Men√∫</h3>
            <button class="modal-btn" id="continue-btn">‚ñ∂Ô∏è Continuar leyendo</button>
            <button class="modal-btn" id="restart-chapter-btn">üîÑ Reiniciar cap√≠tulo</button>
            <button class="modal-btn danger" id="restart-all-btn">üóëÔ∏è Nueva partida</button>
        </div>
    </div>

    <script>
    // ========================================
    // STORY DATA
    // ========================================
    const chapters = {
        "01": {
            title: "Cap√≠tulo 1: El Descubrimiento",
            image: "images/ch01.png",
            content: `
                <p>Todo comenz√≥ un s√°bado lluvioso en {CIUDAD}.</p>
                <p>{NOMBRE} estaba en su cuarto, aburrido, mirando por la ventana las gotas de lluvia que resbalaban por el vidrio. En la pared, un p√≥ster de {INVENTOR_FAVORITO} parec√≠a observarlo con una sonrisa, como dici√©ndole: <em>"Los d√≠as aburridos son perfectos para descubrir algo nuevo."</em></p>
                <p>‚Äî¬°{NOMBRE}! ‚Äîgrit√≥ {AMIGO} desde la puerta‚Äî. ¬°Ten√©s que ver esto!</p>
                <p>{AMIGO} estaba empapado de pies a cabeza, pero ten√≠a los ojos brillantes de emoci√≥n. En la mano llevaba un cuaderno viejo, con las p√°ginas amarillentas y una tapa de cuero gastado.</p>
                <p>‚ÄîLo encontr√© en el contenedor de reciclaje de la calle Mendoza ‚Äîexplic√≥ {AMIGO}, tratando de recuperar el aliento‚Äî. ¬°Mir√° lo que tiene adentro!</p>
                <p>{NOMBRE} tom√≥ el cuaderno con cuidado. Las p√°ginas estaban llenas de dibujos extra√±os: engranajes, poleas, circuitos... y algo que parec√≠a un mapa.</p>
                <p>‚ÄîSon planos de inventos ‚Äîsusurr√≥ {NOMBRE}, pasando las p√°ginas con asombro‚Äî. ¬°Y este mapa... creo que es de nuestro barrio!</p>
                <p>Hab√≠a una X marcada en el mapa, junto a una nota escrita con letra antigua:</p>
                <blockquote>"Para quien tenga la curiosidad de buscar y el ingenio de encontrar."</blockquote>
                <p>Los dos amigos se miraron. Afuera, la lluvia comenzaba a parar.</p>
                <p>‚ÄîEl mapa se√±ala dos lugares ‚Äîdijo {AMIGO}, estudiando el dibujo‚Äî. Uno parece ser... ¬øel s√≥tano de la casa abandonada de la esquina?</p>
                <p>‚ÄîY el otro parece estar en el jard√≠n trasero del viejo molino ‚Äîcomplet√≥ {NOMBRE}.</p>
                <p>En ese momento, como si el universo quisiera darles una pista, escucharon algo. Un ruido bajo y met√°lico que parec√≠a venir de lejos... y una luz extra√±a que parpade√≥ brevemente a trav√©s de la ventana.</p>
                <p>‚Äî¬øEscuchaste eso? ‚Äîpregunt√≥ {AMIGO}.</p>
                <p>‚Äî¬øViste eso? ‚Äîpregunt√≥ {NOMBRE} al mismo tiempo.</p>
            `,
            sabiasQue: `
                <p><strong>Marie Curie</strong> descubri√≥ la radioactividad mientras investigaba por qu√© ciertos minerales brillaban en la oscuridad. ¬°Todo gran descubrimiento empieza con una simple curiosidad!</p>
                <p><strong>Thomas Edison</strong> ten√≠a un cuaderno donde anotaba todas sus ideas, igual que el cuaderno que encontraron {NOMBRE} y {AMIGO}. Lleg√≥ a llenar m√°s de 3,500 cuadernos durante su vida.</p>
            `,
            actividad: `
                <p>¬øTen√©s un cuaderno de ideas? Si no, ¬°pod√©s empezar uno! Anot√° todas las preguntas que te hac√©s durante el d√≠a:</p>
                <ul>
                    <li>¬øPor qu√© el cielo es azul?</li>
                    <li>¬øC√≥mo funciona el WiFi?</li>
                    <li>¬øPor qu√© los aviones no se caen?</li>
                </ul>
                <p>Las mejores invenciones nacen de preguntas simples.</p>
            `,
            decisions: [
                { text: "El ruido extra√±o que viene del s√≥tano de la casa abandonada", subtext: "Va al Cap√≠tulo 2A: El S√≥tano Misterioso", next: "02A" },
                { text: "La luz parpadeante que viene del jard√≠n del viejo molino", subtext: "Va al Cap√≠tulo 2B: Luces en la Noche", next: "02B" }
            ],
            quote: "\"La curiosidad es la mecha que enciende el fuego del descubrimiento.\" ‚Äî An√≥nimo"
        },
        "02A": {
            title: "Cap√≠tulo 2A: El S√≥tano Misterioso",
            image: "images/ch02a.png",
            content: `
                <p>{NOMBRE} y {AMIGO} corrieron bajo los √∫ltimos goterones de lluvia hasta llegar a la casa abandonada de la esquina.</p>
                <p>La casa hab√≠a estado vac√≠a desde que {NOMBRE} ten√≠a memoria. Los vecinos dec√≠an que antes hab√≠a vivido ah√≠ un se√±or muy extra√±o que nunca sal√≠a de d√≠a y que siempre se escuchaban ruidos raros por las noches. Pero eso hab√≠a sido hace muchos a√±os.</p>
                <p>‚ÄîLa gente dice que est√° embrujada ‚Äîsusurr√≥ {AMIGO}‚Äî, pero yo no creo en fantasmas.</p>
                <p>‚ÄîYo tampoco ‚Äîdijo {NOMBRE}, aunque sinti√≥ un escalofr√≠o‚Äî. Los ruidos siempre tienen una explicaci√≥n cient√≠fica. Solo hay que encontrarla.</p>
                <p>Se acercaron a la puerta del s√≥tano, que estaba al costado de la casa, medio escondida entre arbustos crecidos. El ruido met√°lico se escuchaba m√°s fuerte ahora: <em>CLANG... CLANG... CLANG...</em> Un ritmo regular, como el latido de un coraz√≥n mec√°nico.</p>
                <p>‚ÄîEscuch√° ‚Äîdijo {NOMBRE}, arrodill√°ndose junto a la puerta‚Äî. El sonido viene de abajo. Y es r√≠tmico. Eso significa que hay alg√∫n mecanismo funcionando ah√≠ adentro.</p>
                <p>‚Äî¬øUn mecanismo? ¬øDespu√©s de tantos a√±os? ‚Äî{AMIGO} frunci√≥ el ce√±o‚Äî. ¬øDe d√≥nde sacar√≠a energ√≠a?</p>
                <p>Esa era una excelente pregunta. {NOMBRE} record√≥ lo que hab√≠a le√≠do sobre {INVENTOR_FAVORITO}: siempre empezaba pregunt√°ndose "¬øde d√≥nde viene la energ√≠a?"</p>
                <p>La puerta del s√≥tano era de metal pesado, con un candado oxidado. Estaba cerrada.</p>
                <p>‚ÄîNecesitamos entrar ‚Äîdijo {NOMBRE}‚Äî. Pero hay un problema...</p>
                <p>Miraron alrededor. Adem√°s de la puerta principal, hab√≠a una peque√±a ventana lateral, casi al nivel del suelo, que daba al s√≥tano. Estaba sucia pero parec√≠a m√°s accesible.</p>
            `,
            sabiasQue: `
                <p><strong>Los candados</strong> fueron inventados hace m√°s de 4,000 a√±os en la antigua Mesopotamia. ¬°Pero el primer candado con combinaci√≥n fue dise√±ado en Roma!</p>
                <p><strong>La energ√≠a</strong> nunca desaparece, solo se transforma. Esto se llama la "Ley de Conservaci√≥n de la Energ√≠a". Si hay una m√°quina funcionando despu√©s de a√±os, tiene que estar obteniendo energ√≠a de alg√∫n lado: ¬øsolar? ¬øe√≥lica? ¬øalgo m√°s ingenioso?</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: El candado humano</strong></p>
                <p>Intent√° crear un "candado" usando solo materiales de tu casa: palitos de helado, clips, banditas el√°sticas.</p>
                <p>El desaf√≠o: que solo se abra si sab√©s el truco espec√≠fico. ¬°As√≠ es como piensan los inventores de cerraduras!</p>
            `,
            decisions: [
                { text: "Buscar la llave por los alrededores", subtext: "\"Si alguien escondi√≥ algo tan importante ac√°, probablemente dej√≥ una forma de volver a entrar.\"", next: "03A" },
                { text: "Intentar entrar por la ventana lateral", subtext: "\"El camino m√°s dif√≠cil a veces es el m√°s directo. Adem√°s, ¬°ya puedo ver la m√°quina!\"", next: "03B" }
            ],
            quote: "\"Cuando encuentres una puerta cerrada, preguntate: ¬øqui√©n la cerr√≥, y por qu√©?\" ‚Äî Principio de todo buen investigador"
        },
        "02B": {
            title: "Cap√≠tulo 2B: Luces en la Noche",
            image: "images/ch02b.png",
            content: `
                <p>{NOMBRE} y {AMIGO} decidieron seguir la luz misteriosa.</p>
                <p>El viejo molino estaba a unas cuadras de distancia, al final de una calle sin salida que terminaba en un terreno bald√≠o. Nadie lo usaba desde hac√≠a d√©cadas, pero sus aspas de madera todav√≠a giraban cuando hab√≠a viento fuerte.</p>
                <p>‚ÄîAh√≠ est√° otra vez ‚Äîse√±al√≥ {AMIGO}.</p>
                <p>Una luz verdosa parpade√≥ tres veces desde alg√∫n lugar cerca del molino. Luego se apag√≥. Luego volvi√≥ a parpadear: esta vez cinco veces.</p>
                <p>‚ÄîTres... cinco... ‚Äîmurmur√≥ {NOMBRE}, contando‚Äî. ¬øPor qu√© n√∫meros diferentes?</p>
                <p>Llegaron al terreno bald√≠o cuando el sol comenzaba a ponerse detr√°s de las nubes. El molino se alzaba frente a ellos, viejo pero imponente. La luz volvi√≥ a aparecer, esta vez desde una ventana del segundo piso.</p>
                <p>‚Äî¬°Es un patr√≥n! ‚Äîexclam√≥ {NOMBRE} de repente‚Äî. Mir√°: tres parpadeos, pausa, cinco parpadeos, pausa larga. ¬øNo te parece conocido?</p>
                <p>{AMIGO} lo pens√≥ un momento.</p>
                <p>‚Äî¬øC√≥digo Morse? No, eso usa puntos y rayas... ¬øBinario?</p>
                <p>‚Äî¬°N√∫meros primos! ‚Äîdijo {NOMBRE}, emocionado‚Äî. Tres y cinco son n√∫meros primos. Es una secuencia matem√°tica. ¬°Alguien est√° enviando un mensaje!</p>
            `,
            sabiasQue: `
                <p><strong>Los n√∫meros primos</strong> (2, 3, 5, 7, 11, 13...) son tan especiales que los cient√≠ficos los usan para intentar comunicarse con extraterrestres. ¬øPor qu√©? Porque son universales: cualquier civilizaci√≥n inteligente reconocer√≠a un patr√≥n de n√∫meros primos.</p>
                <p><strong>Nikola Tesla</strong> cre√≠a que hab√≠a recibido se√±ales del espacio exterior mientras hac√≠a experimentos con ondas de radio. ¬°Su curiosidad lo llev√≥ a inventar muchas cosas incre√≠bles!</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: Tu propio c√≥digo de luces</strong></p>
                <p>Necesit√°s: una linterna (o la luz del celular) y un amigo o familiar.</p>
                <p>Cre√° tu propio c√≥digo secreto: 1 parpadeo = A, 2 parpadeos = B, 3 parpadeos = C...</p>
                <p>¬°Intent√° enviar un mensaje y que la otra persona lo descifre!</p>
            `,
            decisions: [
                { text: "Construir un detector de se√±ales", subtext: "\"Si construimos algo que capture la luz, podemos analizar exactamente qu√© frecuencia tiene.\"", next: "03C" },
                { text: "Observar y documentar el patr√≥n", subtext: "\"Un buen cient√≠fico primero observa. Si anotamos cada parpadeo, quiz√°s encontremos el mensaje escondido.\"", next: "03D" }
            ],
            quote: "\"La naturaleza habla en el idioma de las matem√°ticas. Solo tenemos que aprender a escucharla.\" ‚Äî Galileo Galilei"
        },
        "03A": {
            title: "Cap√≠tulo 3A: La B√∫squeda",
            image: "images/ch03a.png",
            content: `
                <p>‚ÄîLa llave tiene que estar por ac√° ‚Äîdijo {NOMBRE}, mirando alrededor de la casa abandonada‚Äî. Nadie cierra algo con candado sin guardar una copia de la llave.</p>
                <p>{AMIGO} asinti√≥.</p>
                <p>‚ÄîMi abuela siempre dice que las personas esconden las llaves en lugares "seguros" que en realidad son muy predecibles: debajo del tapete, dentro de una maceta, arriba del marco de la puerta...</p>
                <p>Buscaron en todos esos lugares, pero nada. La llave no aparec√≠a.</p>
                <p>‚ÄîPensemos diferente ‚Äîdijo {NOMBRE}‚Äî. Si el due√±o de esta casa era inventor, ¬øesconder√≠a la llave de manera obvia?</p>
                <p>‚Äî¬°No! ‚Äîlos ojos de {AMIGO} se iluminaron‚Äî. La esconder√≠a de manera ingeniosa. Algo que solo otro inventor entender√≠a.</p>
                <p>Volvieron a examinar el cuaderno que hab√≠an encontrado. En una de las p√°ginas hab√≠a un dibujo de la fachada de una casa, con una flecha que se√±alaba algo en el techo.</p>
                <p>‚Äî¬øEso es... una veleta? ‚Äîpregunt√≥ {NOMBRE}.</p>
                <p>En ese momento, recordaron que Don Carlos, el vecino del frente, ten√≠a fama de coleccionar cosas viejas. Pero tambi√©n el abuelo de Martina ten√≠a ese taller lleno de herramientas...</p>
            `,
            sabiasQue: `
                <p><strong>Las veletas</strong> son uno de los instrumentos meteorol√≥gicos m√°s antiguos. ¬°Los griegos usaban veletas hace m√°s de 2,000 a√±os! Pero tambi√©n se usaban como s√≠mbolos secretos.</p>
                <p><strong>Leonardo da Vinci</strong> dejaba sus notas escritas al rev√©s (en espejo) para que solo pudieran leerlas quienes supieran el truco.</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: Esconde tu propia llave</strong></p>
                <p>Pens√° en un lugar ingenioso para esconder un objeto peque√±o:</p>
                <ul>
                    <li>¬øPuede estar dentro de otro objeto?</li>
                    <li>¬øPuede requerir resolver un acertijo para encontrarla?</li>
                    <li>¬øPuede estar a la vista pero disfrazada?</li>
                </ul>
            `,
            decisions: [
                { text: "Ir al taller del abuelo de Martina", subtext: "\"√âl es mec√°nico y tiene todo tipo de cosas viejas. Quiz√°s la llave estuvo ah√≠ todo este tiempo.\"", next: "04A" },
                { text: "Preguntarle a Don Carlos, el vecino coleccionista", subtext: "\"√âl vive justo enfrente y colecciona cosas antiguas. Seguro sabe algo sobre el inventor original.\"", next: "04A" }
            ],
            quote: "\"Las respuestas m√°s dif√≠ciles a veces las tienen las personas que llevan m√°s tiempo haciendo las preguntas.\" ‚Äî Proverbio inventor"
        },
        "03B": {
            title: "Cap√≠tulo 3B: El Camino Dif√≠cil",
            image: "images/ch03b.png",
            content: `
                <p>‚ÄîPor la ventana entonces ‚Äîdijo {NOMBRE}, acerc√°ndose al peque√±o vidrio que daba al s√≥tano.</p>
                <p>La ventana era m√°s peque√±a de lo que parec√≠a desde lejos, y estaba trabada. A√±os de humedad hab√≠an hinchado la madera del marco, sell√°ndola completamente.</p>
                <p>‚ÄîNo se mueve ‚Äîgru√±√≥ {AMIGO}, intentando empujarla‚Äî. Es como si estuviera pegada.</p>
                <p>{NOMBRE} examin√≥ el marco con atenci√≥n. Pas√≥ los dedos por los bordes, sintiendo la textura de la madera vieja.</p>
                <p>‚ÄîNo est√° pegada ‚Äîdijo despu√©s de un momento‚Äî. Est√° hinchada por la humedad. La madera absorbe agua y se expande. Es f√≠sica b√°sica.</p>
                <p>‚Äî¬øY c√≥mo la des-expandimos?</p>
                <p>{NOMBRE} pens√≥. En su mente aparecieron las p√°ginas de un libro que hab√≠a le√≠do sobre carpinter√≠a. Tambi√©n record√≥ algo que {INVENTOR_FAVORITO} hab√≠a dicho una vez: <em>"Cuando la naturaleza crea un problema, la naturaleza tiene la soluci√≥n."</em></p>
                <p>‚ÄîNecesitamos una herramienta ‚Äîdijo finalmente‚Äî. Algo que nos deje aplicar fuerza de manera precisa sin romper el vidrio.</p>
                <p>{AMIGO} vaci√≥ la mochila en el pasto: un cuaderno, l√°pices, un paquete de chicles, una regla de metal, banditas el√°sticas, y un destornillador peque√±o.</p>
                <p>De pronto, escucharon una voz familiar. Era Martina, del curso, que pasaba en bicicleta.</p>
            `,
            sabiasQue: `
                <p><strong>La madera</strong> absorbe y libera humedad constantemente. Por eso las puertas viejas se traban en verano (humedad alta) y se aflojan en invierno (humedad baja).</p>
                <p><strong>MacGyver</strong> es un personaje de TV famoso por resolver problemas usando solo lo que ten√≠a a mano. Pero en la vida real, los ingenieros de NASA hacen esto constantemente!</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: Herramientas improvisadas</strong></p>
                <p>Desaf√≠o: Abr√≠ una caja de cart√≥n cerrada con cinta SIN usar tijeras ni cuchillos.</p>
                <p>Opciones a probar: una regla, la punta de un l√°piz, tus propias u√±as + paciencia.</p>
                <p>¬øCu√°l funcion√≥ mejor?</p>
            `,
            decisions: [
                { text: "Construir una herramienta con los materiales de la mochila", subtext: "\"Puedo hacer una especie de palanca combinando la regla y el destornillador.\"", next: "05A" },
                { text: "Pedirle ayuda a Martina (y contarle la verdad)", subtext: "\"Tres cabezas piensan mejor que dos. Adem√°s, Martina es buena resolviendo problemas.\"", next: "05A" }
            ],
            quote: "\"El ingenio no es tener las herramientas correctas; es hacer correctas las herramientas que ten√©s.\" ‚Äî Proverbio maker"
        },
        "03C": {
            title: "Cap√≠tulo 3C: El Primer Invento",
            image: "images/ch03c.png",
            content: `
                <p>‚ÄîVamos a construir un detector ‚Äîdecidi√≥ {NOMBRE}, abriendo el cuaderno en la p√°gina de los diagramas.</p>
                <p>El dibujo mostraba un aparato simple: una caja, un sensor de luz, y algo que parec√≠a una pantalla o un indicador. Las notas al costado explicaban:</p>
                <blockquote>"Detector fot√≥nico b√°sico. Captura longitud de onda y frecuencia. Materiales: cualquier cosa que reaccione a la luz."</blockquote>
                <p>‚Äî¬øCualquier cosa que reaccione a la luz? ‚Äî{AMIGO} levant√≥ una ceja‚Äî. ¬øC√≥mo qu√©?</p>
                <p>‚Äî¬øY una calculadora solar? ‚Äîsugiri√≥ {AMIGO}‚Äî. Mi hermanito tiene una. Funciona con luz.</p>
                <p>‚Äî¬°S√≠! La celda solar de la calculadora genera electricidad cuando le da la luz. Si conectamos algo que mida esa electricidad...</p>
                <p>Los dos amigos corrieron a la casa de {AMIGO} y volvieron con: una calculadora solar vieja, un par de auriculares rotos, cinta aisladora, y cables de un juguete roto.</p>
                <p>Despu√©s de veinte minutos de trabajo (y varios intentos fallidos), el detector estaba listo. Era feo, lleno de cinta y cables, pero cuando {AMIGO} lo apunt√≥ hacia una l√°mpara de la calle que empezaba a parpadear...</p>
                <p><em>Clic. Clic. Clic.</em></p>
                <p>‚Äî¬°FUNCIONA! ‚Äîgritaron los dos al mismo tiempo.</p>
            `,
            sabiasQue: `
                <p><strong>Las celdas solares</strong> fueron inventadas en 1954 en los laboratorios Bell. ¬°Pero la primera en el espacio fue en 1958, en el sat√©lite Vanguard 1!</p>
                <p><strong>Los auriculares</strong> funcionan al rev√©s que los micr√≥fonos: el micr√≥fono convierte sonido en electricidad, y los auriculares convierten electricidad en sonido.</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: Detector de luz casero</strong></p>
                <p>Necesit√°s: una calculadora solar, auriculares viejos (que no uses).</p>
                <p>Con ayuda de un adulto: pel√° los cables de los auriculares y conectalos a donde van las bater√≠as de la calculadora.</p>
                <p>‚ö†Ô∏è ¬°Hacelo siempre con supervisi√≥n adulta!</p>
            `,
            decisions: [
                { text: "Materiales reciclados del terreno bald√≠o", subtext: "\"Hay un mont√≥n de cosas tiradas ac√°: latas, botellas, cables viejos. ¬°Podemos hacer un detector profesional sin gastar nada!\"", next: "05A" },
                { text: "El kit de electr√≥nica de {AMIGO}", subtext: "\"Mi pap√° me regal√≥ un kit de electr√≥nica que nunca abr√≠. ¬°Es el momento de usarlo!\"", next: "05A" }
            ],
            quote: "\"El primer invento nunca es perfecto. Pero el primer invento siempre es el m√°s importante.\" ‚Äî Filosof√≠a maker"
        },
        "03D": {
            title: "Cap√≠tulo 3D: El M√©todo Cient√≠fico",
            image: "images/ch03d.png",
            content: `
                <p>‚ÄîEsper√° ‚Äîdijo {NOMBRE}, sacando un l√°piz y el cuaderno‚Äî. Antes de hacer cualquier cosa, tenemos que observar.</p>
                <p>‚Äî¬øObservar qu√© exactamente?</p>
                <p>‚ÄîTodo. ¬øCu√°ntas veces parpadea la luz? ¬øCu√°nto dura cada parpadeo? ¬øHay pausas? ¬øEl color cambia? Si esto es un mensaje, tenemos que registrar todos los datos antes de interpretarlos.</p>
                <p>Se sentaron en el pasto h√∫medo frente al molino. {NOMBRE} dividi√≥ una p√°gina del cuaderno en columnas y empez√≥ a anotar:</p>
                <blockquote>18:32 - 3 parpadeos - Verde brillante<br>
                18:33 - 5 parpadeos - Verde<br>
                18:35 - 7 parpadeos - Verde ¬øm√°s r√°pido?<br>
                18:36 - 11 parpadeos - ¬°Verde-azul! ¬°Cambi√≥!</blockquote>
                <p>‚Äî¬°Mir√° esto! ‚Äîexclam√≥ {NOMBRE} despu√©s de diez minutos de observaci√≥n‚Äî. 3, 5, 7, 11... ¬°Son todos n√∫meros primos!</p>
                <p>Siguieron observando. A las 18:40, la luz cambi√≥ de color completamente: ahora era azul. Y los n√∫meros cambiaron tambi√©n: 1, 1, 2, 3, 5, 8...</p>
                <p>‚ÄîEso es la secuencia de Fibonacci ‚Äîdijo {AMIGO}‚Äî. Cada n√∫mero es la suma de los dos anteriores.</p>
                <p>{NOMBRE} sinti√≥ un escalofr√≠o que no era por el fr√≠o.</p>
                <p>‚ÄîQuien est√© haciendo esto conoce matem√°ticas. Y quiere que alguien lo note.</p>
            `,
            sabiasQue: `
                <p><strong>El m√©todo cient√≠fico</strong> tiene pasos que usan los cient√≠ficos de todo el mundo: Observar, Preguntar, Hipotetizar, Experimentar, Analizar, Concluir. ¬°{NOMBRE} y {AMIGO} est√°n usando los primeros pasos sin saberlo!</p>
                <p><strong>La secuencia de Fibonacci</strong> aparece en todas partes de la naturaleza: los p√©talos de las flores, las espirales de los caracoles, las ramas de los √°rboles.</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: Cient√≠fico por un d√≠a</strong></p>
                <p>Eleg√≠ algo que observar durante 10 minutos: p√°jaros, autos, nubes...</p>
                <p>Hac√© una tabla. Anot√°: Hora, Qu√© ves, Cu√°ntos, Algo raro o interesante.</p>
                <p>¬øEncontraste alg√∫n patr√≥n?</p>
            `,
            decisions: [
                { text: "Las luces tienen un patr√≥n matem√°tico: es un c√≥digo", subtext: "\"Si descifro el c√≥digo, voy a entender el mensaje. Necesito analizar m√°s los datos.\"", next: "05A" },
                { text: "Las luces vienen del viejo molino: hay que ir all√°", subtext: "\"Los datos son interesantes, pero la respuesta real est√° en el molino. ¬°Vamos a investigar!\"", next: "05A" }
            ],
            quote: "\"En la ciencia, los datos son el mapa. Pero igual ten√©s que caminar el territorio.\" ‚Äî Consejo de exploradores"
        },
        "04A": {
            title: "Cap√≠tulo 4A: Secretos del Abuelo",
            image: "images/ch04a.png",
            content: `
                <p>El taller del abuelo de Martina estaba al final de la calle, en un galp√≥n con techo de chapa que siempre ol√≠a a aceite de m√°quinas y aserr√≠n.</p>
                <p>‚Äî¬øDon Ernesto? ‚Äîllam√≥ {NOMBRE} desde la puerta‚Äî. ¬øEst√°?</p>
                <p>El anciano apareci√≥ detr√°s de un torno viejo, limpi√°ndose las manos con un trapo. Ten√≠a el pelo blanco, anteojos gruesos, y una sonrisa que le arrugaba toda la cara.</p>
                <p>‚Äî¬°{NOMBRE}! ¬°{AMIGO}! ¬øQu√© los trae por ac√°?</p>
                <p>{NOMBRE} le mostr√≥ el cuaderno con el dibujo de la veleta.</p>
                <p>‚ÄîUna llave que abra el s√≥tano de la casa abandonada de la esquina. Creemos que el due√±o original era inventor, como usted.</p>
                <p>Don Ernesto se qued√≥ muy quieto. Sus ojos se humedecieron un poco detr√°s de los anteojos.</p>
                <p>‚ÄîEse cuaderno era de mi hermano. De Alberto. √âl fue quien construy√≥ todo lo que hay en ese s√≥tano.</p>
                <p>Los dos amigos se miraron, asombrados.</p>
                <p>Don Ernesto camin√≥ hasta un estante polvoriento. Movi√≥ algunas cajas, sac√≥ un reloj de cuco que no funcionaba, y de adentro extrajo una llave de bronce con forma de engranaje.</p>
                <p>‚ÄîLa guard√© todos estos a√±os esperando que alguien con suficiente curiosidad la buscara. Creo que ustedes son esas personas.</p>
            `,
            sabiasQue: `
                <p><strong>Muchos inventores</strong> fueron incomprendidos en su √©poca. Nikola Tesla muri√≥ solo y pobre, a pesar de haber inventado la corriente alterna que usamos hoy.</p>
                <p><strong>Las llaves con forma especial</strong> se llaman "llaves maestras" o "llaves de seguridad". Algunos inventores dise√±aban llaves √∫nicas para sus talleres.</p>
            `,
            actividad: null,
            decisions: [
                { text: "Ir al s√≥tano con la llave", subtext: "Con la llave en mano, {NOMBRE} y {AMIGO} corrieron de vuelta a la casa abandonada...", next: "05A" }
            ],
            quote: "\"Los secretos de familia a veces son inventos esperando ser descubiertos.\" ‚Äî Tradici√≥n de inventores"
        },
        "05A": {
            title: "Cap√≠tulo 5A: El Laboratorio Secreto",
            image: "images/ch05a.png",
            content: `
                <p>{NOMBRE} baj√≥ los escalones de metal con el coraz√≥n latiendo con fuerza. {AMIGO} lo segu√≠a de cerca, alumbrando con la linterna del celular.</p>
                <p>El s√≥tano era m√°s grande de lo que hab√≠an imaginado. Mucho m√°s grande.</p>
                <p>‚ÄîEsto es... incre√≠ble ‚Äîsusurr√≥ {AMIGO}.</p>
                <p>Era un laboratorio completo. Mesas de trabajo cubiertas de herramientas. Estantes llenos de frascos, cables, y componentes electr√≥nicos. Pizarrones con f√≥rmulas escritas en tiza. Y en el centro, la fuente del ruido:</p>
                <p>Una m√°quina enorme, del tama√±o de un auto, hecha de engranajes de cobre, tubos de vidrio, y cables que brillaban con una luz azulada. Giraba lentamente, produciendo el sonido met√°lico que hab√≠an escuchado desde afuera.</p>
                <p><em>CLANG... CLANG... CLANG...</em></p>
                <p>Hab√≠a una placa de metal en la base de la m√°quina:</p>
                <blockquote><strong>PROYECTO AURORA</strong><br>Generador de Energ√≠a Perpetua<br>Alberto M√©ndez - 1985</blockquote>
                <p>‚ÄîEnerg√≠a perpetua ‚Äîley√≥ {AMIGO}‚Äî. ¬øEso es posible?</p>
                <p>{AMIGO} encontr√≥ otro cuaderno con la inscripci√≥n: <em>"Para quien tenga la curiosidad de continuar."</em></p>
                <p>Adentro hab√≠a una carta:</p>
                <blockquote><em>Querido descubridor:</em><br><br>Si est√°s leyendo esto, significa que mi laboratorio encontr√≥ su nuevo due√±o. El Proyecto Aurora funciona, pero est√° incompleto. Genera energ√≠a limpia e infinita, pero todav√≠a no s√© c√≥mo compartirla con el mundo. Esa parte la dejo para quien venga despu√©s.<br><br>‚Äî Alberto</blockquote>
            `,
            sabiasQue: `
                <p><strong>La "energ√≠a perpetua"</strong> es un sue√±o que los inventores persiguen desde hace siglos. La f√≠sica moderna dice que es imposible, pero eso no detiene a los so√±adores.</p>
                <p><strong>Nikola Tesla</strong> trabaj√≥ en un sistema para transmitir electricidad sin cables a todo el mundo. Nunca lo termin√≥, pero hoy tenemos cargadores inal√°mbricos gracias a sus ideas.</p>
            `,
            actividad: `
                <p><strong>Mini-experimento: Tu laboratorio secreto</strong></p>
                <p>Si tuvieras un laboratorio secreto, ¬øqu√© inventar√≠as?</p>
                <p>Escrib√≠ o dibuj√°: El nombre de tu invento, un problema que resuelve, los materiales que necesitar√≠as.</p>
            `,
            decisions: [
                { text: "Usarlo para crear inventos propios y ayudar al barrio", subtext: "\"Alberto dej√≥ todo esto para que alguien continuara. ¬°Podemos aprender, experimentar, y crear cosas nuevas!\"", next: "FINAL1" }
            ],
            quote: "\"Un laboratorio no es un lugar. Es un estado mental: el estado de querer entender.\" ‚Äî Filosof√≠a cient√≠fica"
        },
        "FINAL1": {
            title: "Final: Inventores del Barrio",
            image: "images/final.png",
            content: `
                <h3>Seis meses despu√©s...</h3>
                <p>El cartel sobre la puerta del s√≥tano ahora dec√≠a:</p>
                <blockquote><strong>üîß CLUB DE INVENTORES DEL BARRIO üîß</strong><br>Todos los s√°bados de 10 a 13<br>¬°Tra√© tu curiosidad!</blockquote>
                <p>{NOMBRE} ajust√≥ el √∫ltimo tornillo de la l√°mpara solar que hab√≠a construido para la plaza. A su lado, {AMIGO} terminaba de programar el sistema de riego autom√°tico para el jard√≠n comunitario. Martina probaba un carrito el√©ctrico hecho con partes de bicicletas viejas.</p>
                <p>‚Äî¬°Funciona! ‚Äîgrit√≥ Martina, dando una vuelta por el estacionamiento.</p>
                <p>El laboratorio secreto de Alberto ya no era secreto. Se hab√≠a convertido en el coraz√≥n del barrio: un lugar donde cualquier persona pod√≠a venir a aprender, crear, y resolver problemas.</p>
                <p>Don Ernesto ven√≠a todos los s√°bados a ense√±ar a los m√°s chicos c√≥mo usar las herramientas. Dec√≠a que era lo que Alberto hubiera querido.</p>
                <p>La puerta del laboratorio se abri√≥. Un grupo de chicos del barrio entr√≥ corriendo, cada uno con alg√∫n aparato roto en las manos.</p>
                <p>‚Äî¬°{NOMBRE}! ¬°{AMIGO}! ‚Äîgritaron‚Äî. ¬øNos ayudan a arreglar esto?</p>
                <p>{NOMBRE} sonri√≥.</p>
                <p>‚ÄîMejor todav√≠a: les ense√±amos a arreglarlo ustedes mismos.</p>
            `,
            sabiasQue: null,
            actividad: null,
            decisions: [],
            quote: "\"El mejor momento para inventar es ahora. El mejor lugar es donde est√©s. La mejor herramienta es tu mente.\"",
            isFinal: true,
            achievements: [
                { badge: "üîì", text: "Explorador/a: Encontraste el cuaderno y seguiste las pistas" },
                { badge: "üî¨", text: "Cient√≠fico/a: Usaste el m√©todo cient√≠fico para resolver misterios" },
                { badge: "üîß", text: "Constructor/a: Creaste inventos con tus propias manos" },
                { badge: "üëë", text: "L√≠der: Formaste un equipo y ayudaste a la comunidad" },
                { badge: "üìö", text: "Maestro/a: Ense√±aste a otros lo que aprendiste" }
            ],
            learnings: [
                "La curiosidad es contagiosa. Cuando una persona hace preguntas, otros empiezan a hacer preguntas tambi√©n.",
                "Los mejores inventos resuelven problemas reales.",
                "Inventar es mejor en equipo.",
                "El conocimiento crece cuando se comparte."
            ]
        }
    };

    // ========================================
    // APP STATE
    // ========================================
    let state = {
        nombre: "",
        amigo: "",
        ciudad: "",
        inventor: "",
        currentChapter: "01",
        history: []
    };

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const welcomeScreen = document.getElementById('welcome-screen');
    const storyScreen = document.getElementById('story-screen');
    const progressBar = document.getElementById('progress-bar');
    const form = document.getElementById('personalization-form');
    const menuModal = document.getElementById('menu-modal');

    // ========================================
    // FUNCTIONS
    // ========================================
    function replaceVariables(text) {
        return text
            .replace(/\{NOMBRE\}/g, state.nombre)
            .replace(/\{AMIGO\}/g, state.amigo)
            .replace(/\{CIUDAD\}/g, state.ciudad)
            .replace(/\{INVENTOR_FAVORITO\}/g, state.inventor);
    }

    function saveState() {
        localStorage.setItem('clubInventores', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('clubInventores');
        if (saved) {
            state = JSON.parse(saved);
            return true;
        }
        return false;
    }

    function calculateProgress() {
        const totalChapters = Object.keys(chapters).length;
        const visited = state.history.length;
        return Math.min((visited / totalChapters) * 100, 100);
    }

    function renderChapter(chapterId) {
        const chapter = chapters[chapterId];
        if (!chapter) return;

        state.currentChapter = chapterId;
        if (!state.history.includes(chapterId)) {
            state.history.push(chapterId);
        }
        saveState();

        // Update progress bar
        document.getElementById('progress-text').textContent = chapter.title.split(':')[0];
        document.getElementById('progress-fill').style.width = calculateProgress() + '%';

        // Image
        const imgEl = document.getElementById('chapter-image');
        imgEl.src = chapter.image;
        imgEl.alt = chapter.title;

        // Title
        document.getElementById('chapter-title').textContent = chapter.title;

        // Content
        document.getElementById('chapter-content').innerHTML = replaceVariables(chapter.content);

        // Extras (sabias que + actividad)
        let extrasHTML = '';
        if (chapter.sabiasQue) {
            extrasHTML += `
                <div class="info-box sabias-que">
                    <h3>üí≠ ¬øSab√≠as que...?</h3>
                    ${replaceVariables(chapter.sabiasQue)}
                </div>
            `;
        }
        if (chapter.actividad) {
            extrasHTML += `
                <div class="info-box actividad">
                    <h3>üîß Actividad para el lector</h3>
                    ${replaceVariables(chapter.actividad)}
                </div>
            `;
        }
        
        // Final achievements
        if (chapter.isFinal) {
            extrasHTML += `
                <div class="ending">
                    <h2>üéñÔ∏è ¬°Felicitaciones, ${state.nombre}!</h2>
                    <p>Completaste "El Club de los Inventores"</p>
                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                </div>
                <h3 style="margin: 1.5rem 0 1rem;">Lo que ${state.nombre} aprendi√≥:</h3>
                <div class="info-box">
                    ${chapter.learnings.map(l => `<p>‚ú® ${l}</p>`).join('')}
                </div>
                <h3 style="margin: 1.5rem 0 1rem;">üéñÔ∏è Logros desbloqueados:</h3>
                <div class="achievements">
                    ${chapter.achievements.map(a => `
                        <div class="achievement">
                            <span class="badge">${a.badge}</span>
                            <span class="text">${a.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        document.getElementById('chapter-extras').innerHTML = extrasHTML;

        // Decisions
        const decisionsContainer = document.getElementById('decisions-container');
        const decisionBox = document.getElementById('chapter-decisions');
        
        if (chapter.decisions && chapter.decisions.length > 0) {
            decisionBox.classList.remove('hidden');
            decisionsContainer.innerHTML = chapter.decisions.map(d => `
                <button class="decision-btn" data-next="${d.next}">
                    <span class="option">üëâ ${replaceVariables(d.text)}</span>
                    <span class="description">${replaceVariables(d.subtext)}</span>
                </button>
            `).join('');
        } else {
            decisionBox.classList.add('hidden');
            if (chapter.isFinal) {
                decisionsContainer.innerHTML = `
                    <button class="btn btn-secondary" onclick="restartGame()">üîÑ Jugar de nuevo con otras decisiones</button>
                `;
                decisionBox.classList.remove('hidden');
            }
        }

        // Quote
        document.getElementById('chapter-quote').textContent = chapter.quote || '';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function startStory() {
        welcomeScreen.style.display = 'none';
        storyScreen.style.display = 'block';
        progressBar.classList.remove('hidden');
        renderChapter(state.currentChapter);
    }

    function restartGame() {
        state.currentChapter = "01";
        state.history = [];
        saveState();
        renderChapter("01");
    }

    function newGame() {
        localStorage.removeItem('clubInventores');
        location.reload();
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        state.nombre = document.getElementById('input-nombre').value.trim();
        state.amigo = document.getElementById('input-amigo').value.trim();
        state.ciudad = document.getElementById('input-ciudad').value.trim();
        state.inventor = document.getElementById('input-inventor').value;
        state.currentChapter = "01";
        state.history = [];
        saveState();
        startStory();
    });

    document.getElementById('decisions-container').addEventListener('click', (e) => {
        const btn = e.target.closest('.decision-btn');
        if (btn && btn.dataset.next) {
            renderChapter(btn.dataset.next);
        }
    });

    document.getElementById('menu-btn').addEventListener('click', () => {
        menuModal.classList.add('active');
    });

    document.getElementById('continue-btn').addEventListener('click', () => {
        menuModal.classList.remove('active');
    });

    document.getElementById('restart-chapter-btn').addEventListener('click', () => {
        menuModal.classList.remove('active');
        renderChapter(state.currentChapter);
    });

    document.getElementById('restart-all-btn').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro? Vas a perder todo el progreso.')) {
            newGame();
        }
    });

    menuModal.addEventListener('click', (e) => {
        if (e.target === menuModal) {
            menuModal.classList.remove('active');
        }
    });

    // ========================================
    // INIT
    // ========================================
    if (loadState() && state.nombre) {
        // Resume saved game
        document.getElementById('input-nombre').value = state.nombre;
        document.getElementById('input-amigo').value = state.amigo;
        document.getElementById('input-ciudad').value = state.ciudad;
        document.getElementById('input-inventor').value = state.inventor;
        
        if (confirm(`¬°Hola de nuevo, ${state.nombre}! ¬øQuer√©s continuar tu aventura?`)) {
            startStory();
        }
    }
    </script>
</body>
</html>
